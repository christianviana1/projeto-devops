version: '3.8'

services:
  backend:
    build: ./backend
    container_name: backend-devops
    ports:
      - "${BACKEND_PORT}:3000"
    environment:
      - MONGO_URL=mongodb://${MONGODB_USER}:${MONGODB_PASSWORD}@${MONGODB_IP}:27017/${MONGODB_DATABASE}?authSource=admin
      - PORT=3000
    volumes:
      - pdf-uploads:/app/uploads
    restart: unless-stopped
    networks:
      - devops-network

  frontend:
    build: 
      context: ./frontend
      args:
        - API_URL=http://${APP_IP}:${BACKEND_PORT}
    container_name: frontend-devops
    ports:
      - "${FRONTEND_PORT}:80"
    depends_on:
      - backend
    restart: unless-stopped
    networks:
      - devops-network

  # MySQL para o Zabbix
  mysql:
    image: mysql:8.0
    container_name: mysql-zabbix
    environment:
      - MYSQL_DATABASE=${MYSQL_DATABASE}
      - MYSQL_USER=${MYSQL_USER}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
    volumes:
      - mysql-data:/var/lib/mysql
    restart: unless-stopped
    networks:
      - devops-network
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_bin

  # Zabbix Server
  zabbix-server:
    image: zabbix/zabbix-server-mysql:alpine-latest
    container_name: zabbix-server
    environment:
      - DB_SERVER_HOST=mysql
      - MYSQL_DATABASE=${MYSQL_DATABASE}
      - MYSQL_USER=${MYSQL_USER}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
    ports:
      - "10051:10051"
    depends_on:
      - mysql
    restart: unless-stopped
    networks:
      - devops-network

  # Zabbix Web Interface
  zabbix-web:
    image: zabbix/zabbix-web-nginx-mysql:alpine-latest
    container_name: zabbix-web
    environment:
      - DB_SERVER_HOST=mysql
      - MYSQL_DATABASE=${MYSQL_DATABASE}
      - MYSQL_USER=${MYSQL_USER}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
      - ZBX_SERVER_HOST=zabbix-server
      - PHP_TZ=America/Sao_Paulo
    ports:
      - "${ZABBIX_WEB_PORT}:8080"
    depends_on:
      - mysql
      - zabbix-server
    restart: unless-stopped
    networks:
      - devops-network

  # Grafana
  grafana:
    image: grafana/grafana:latest
    container_name: grafana-devops
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD}
      - GF_INSTALL_PLUGINS=alexanderzobnin-zabbix-app
    ports:
      - "${GRAFANA_PORT}:3000"
    volumes:
      - grafana-data:/var/lib/grafana
    depends_on:
      - zabbix-server
    restart: unless-stopped
    networks:
      - devops-network

networks:
  devops-network:
    driver: bridge

volumes:
  mysql-data:
  grafana-data:
  pdf-uploads: